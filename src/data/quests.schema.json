{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/quests.schema.json",
  "title": "Quest Catalog",
  "description": "Schema for quest definitions stored in YAML.",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "quests"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Catalog version used to refresh stored quest state when newer."
    },
    "actors": {
      "type": "array",
      "description": "List of quest actors used by quest content.",
      "default": [],
      "items": { "$ref": "#/$defs/actor" }
    },
    "quests": {
      "type": "array",
      "description": "List of quest definitions.",
      "minItems": 1,
      "items": { "$ref": "#/$defs/quest" }
    }
  },
  "$defs": {
    "actor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "name_color", "voice", "avatar_url", "prompt"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique actor identifier.",
          "pattern": "^[A-Za-z0-9_\\-]+$"
        },
        "name": {
          "type": "string",
          "description": "Display name for this actor."
        },
        "name_color": {
          "type": "string",
          "description": "Display color used for this actor's name in chat.",
          "pattern": "^#[0-9A-Fa-f]{6}$"
        },
        "voice": {
          "type": "string",
          "description": "Voice identifier used by TTS."
        },
        "avatar_url": {
          "type": "string",
          "description": "Avatar URL (external URL or avatar://<avatarId>)."
        },
        "prompt": {
          "type": "string",
          "description": "Prompt/personality text associated with this actor."
        }
      }
    },
    "quest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "description", "stages"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique quest identifier.",
          "pattern": "^[A-Za-z0-9_\\-]+$"
        },
        "title": {
          "type": "string",
          "description": "Short quest title shown to the player."
        },
        "description": {
          "type": "string",
          "description": "General quest description."
        },
        "active": {
          "type": "boolean",
          "description": "Whether the quest starts active by default.",
          "default": false
        },
        "initial_stage_id": {
          "type": "string",
          "description": "Stage id that should be used when the quest starts.",
          "pattern": "^[A-Za-z0-9_\\-]+$"
        },
        "stages": {
          "type": "array",
          "description": "Ordered or referenced quest stages.",
          "minItems": 1,
          "items": { "$ref": "#/$defs/stage" }
        },
        "fallback_stage": {
          "$ref": "#/$defs/fallbackStage"
        }
      }
    },
    "stage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "description", "instructions"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique stage identifier within the quest.",
          "pattern": "^[A-Za-z0-9_\\-]+$"
        },
        "description": {
          "type": "string",
          "description": "Short summary of the stage."
        },
        "instructions": {
          "type": "string",
          "description": "Player-facing instructions for this stage."
        },
        "plan": {
          "type": "array",
          "description": "Condition/action pairs evaluated for this stage.",
          "items": { "$ref": "#/$defs/planStep" },
          "default": []
        }
      }
    },
    "fallbackStage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["description", "instructions"],
      "properties": {
        "description": {
          "type": "string",
          "description": "Short summary of the fallback stage."
        },
        "instructions": {
          "type": "string",
          "description": "Player-facing instructions for the fallback stage."
        },
        "plan": {
          "type": "array",
          "description": "Condition/action pairs evaluated for the fallback stage.",
          "items": { "$ref": "#/$defs/planStep" },
          "default": []
        }
      }
    },
    "condition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["source", "path", "operator", "value"],
      "properties": {
        "source": {
          "type": "string",
          "description": "Where to read the value from.",
          "enum": ["event"]
        },
        "path": {
          "type": "string",
          "description": "Dot-delimited path to the value, e.g. Cargo.TotalItems or event.MarketId."
        },
        "operator": {
          "type": "string",
          "description": "Comparison operator (currently only equality is supported).",
          "enum": ["equals", "=="]
        },
        "value": {
          "description": "Expected value for the comparison.",
          "type": ["string", "number", "boolean", "null"]
        }
      }
    },
    "planAction": {
      "type": "object",
      "required": ["action"],
      "properties": {
        "action": {
          "type": "string",
          "description": "Action to execute when step conditions are met.",
          "enum": ["log", "advance_stage", "set_active", "play_sound", "npc_message"]
        }
      },
      "oneOf": [
        {
          "additionalProperties": false,
          "properties": {
            "action": { "const": "log" },
            "message": { "type": "string" }
          },
          "required": ["action", "message"]
        },
        {
          "additionalProperties": false,
          "properties": {
            "action": { "const": "advance_stage" },
            "target_stage_id": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]+$" }
          },
          "required": ["action", "target_stage_id"]
        },
        {
          "additionalProperties": false,
          "properties": {
            "action": { "const": "set_active" },
            "quest_id": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]+$" },
            "active": { "type": "boolean" }
          },
          "required": ["action", "quest_id"]
        },
        {
          "additionalProperties": false,
          "properties": {
            "action": { "const": "play_sound" },
            "file_name": { "type": "string" },
            "transcription": { "type": "string" },
            "actor_id": { "type": ["string", "null"], "pattern": "^[A-Za-z0-9_\\-]+$" }
          },
          "required": ["action", "file_name", "transcription"]
        },
        {
          "additionalProperties": false,
          "properties": {
            "action": { "const": "npc_message" },
            "actor_id": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]+$" },
            "transcription": { "type": "string" }
          },
          "required": ["action", "actor_id", "transcription"]
        }
      ]
    },
    "planStep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["conditions", "actions"],
      "properties": {
        "conditions": {
          "type": "array",
          "description": "Conditions that must be met to execute this action list.",
          "items": { "$ref": "#/$defs/condition" },
          "default": []
        },
        "actions": {
          "type": "array",
          "description": "List of actions to execute when the step conditions are met.",
          "minItems": 1,
          "items": { "$ref": "#/$defs/planAction" }
        }
      }
    }
  }
}
