<div class="overlay-container" 
     [class.position-left]="avatarPosition === 'left'" 
     [class.position-right]="avatarPosition === 'right'"
     *ngIf="avatarShow || chatShow">
    <div class="overlay-character" [ngClass]="action">
        <div class="overlay-pngtuber" 
             [ngClass]="action"
             *ngIf="avatarShow"
             #pngtuberElement></div>
        <div class="overlay-character-info" *ngIf="activeCharacters.length">
            @for (character of activeCharacters; track character.name) {
                <div class="character-chip">
                    <div class="chip-avatar" [style.border-color]="character.color">
                        @if (character.avatarUrl) {
                            <img [src]="character.avatarUrl" [alt]="character.name + ' avatar'">
                        } @else {
                            <span class="chip-color" [style.background-color]="character.color"></span>
                        }
                    </div>
                    <div class="chip-details">
                        <span class="chip-name" [style.color]="character.color">{{ character.name }}</span>
                        <span class="chip-voice" *ngIf="character.voice">({{ character.voice }})</span>
                    </div>
                </div>
            }
        </div>
        <div class="overlay-chat" *ngIf="chatShow">
<!--            <p class="ready-text" *ngIf="runMode=='starting'">System preparing...</p>-->
            @for (msg of chat; track msg.index) {
              <div class="chat-entry">
                <span class="timestamp">{{ msg.timestamp | date:'HH:mm:ss' }}</span>
                <span class="prefix" [style.color]="getLogColor(msg.role)">{{ msg.role }}</span>
                <span class="message">
                    <ng-container *ngFor="let segment of msg.segments; let last = last">
                        <span class="message-segment" [style.color]="segment.color">{{ segment.text }}</span>
                        <br *ngIf="!last">
                    </ng-container>
                </span>
              </div>
            }

        </div>
    </div>
</div>
