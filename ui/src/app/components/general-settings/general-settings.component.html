<div class="settings-grid">
    @if (config) {
        <mat-form-field>
            <mat-label>Commander Name</mat-label>
            <input required matInput [(ngModel)]="config.commander_name"
                    (ngModelChange)="onConfigChange({commander_name: $event})">
        </mat-form-field>

        <p>Enter your API key from 
            <a target="_blank" rel="noopener noreferrer" href="https://platform.openai.com/api-keys">OpenAI</a>, 
            <a target="_blank" rel="noopener noreferrer" href="https://aistudio.google.com/app/apikey">Google AI Studio</a>, or 
            <a target="_blank" rel="noopener noreferrer" href="https://openrouter.ai/settings/keys">OpenRouter</a>. 
            The system will automatically detect the key type and configure settings.</p>
        <mat-form-field>
            <mat-label>Main API Key (OpenAI/Openrouter/Google AI Studio)</mat-label>
            <input required matInput [type]="hideApiKey ? 'password' : 'text'" [(ngModel)]="config.api_key"
                    (ngModelChange)="onApiKeyChange($event)"
                    pattern="^[A-Za-z0-9_.-]+$"
                    #apiKeyInput="ngModel">
            <button matSuffix mat-icon-button (mousedown)="hideApiKey = false" (mouseup)="hideApiKey = true"
                    (mouseleave)="hideApiKey = true">
                <mat-icon>{{ hideApiKey ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-hint *ngIf="apiKeyType">Detected: {{ apiKeyType }} - Advanced settings have been configured automatically</mat-hint>
            <mat-error *ngIf="apiKeyInput.errors?.['pattern']">
                API key can only contain letters, numbers, underscores, dots, and hyphens
            </mat-error>
        </mat-form-field>

        <h2>Audio</h2>
        <p>Choose when the AI listens. We recommend using Push-to-Talk to avoid accidental activation.
            Voice activation should only be used wearing headphones.</p>
        <div class="ptt-container">
            <mat-form-field>
                <mat-label>Microphone Mode</mat-label>
                <mat-select [value]="config.ptt_var"
                            (selectionChange)="onConfigChange({ptt_var: $event.value})">
                    <mat-option value="voice_activation">Voice Detection (Use Headphones)</mat-option>
                    <mat-option value="push_to_talk">Push-to-Talk (Recommended)</mat-option>
                    <mat-option value="push_to_mute">Push-to-Mute</mat-option>
                    <mat-option value="toggle">Toggle Mic On/Off</mat-option>
                </mat-select>
            </mat-form-field>
            @if (config.ptt_var !== 'voice_activation') {
                <mat-form-field (click)="onAssignPTT($event)">
                    <mat-label>Hotkey</mat-label>
                    <input required matInput [value]="isAssigningPTT ? 'Press any key...' : config.ptt_key" readonly>
                    <button matSuffix mat-icon-button>
                        <mat-icon>keyboard</mat-icon>
                    </button>
                </mat-form-field>
            }
            @if (config.ptt_var === 'toggle') {
                <mat-slide-toggle [(ngModel)]="config.ptt_inverted_var"
                                  (ngModelChange)="onConfigChange({ptt_inverted_var: $event})">
                    Start with Mic Muted
                </mat-slide-toggle>
            }
            @if (config.ptt_var !== 'push_to_talk') {
                <mat-slide-toggle [(ngModel)]="config.mute_during_response_var"
                                    (ngModelChange)="onConfigChange({mute_during_response_var: $event})">
                    Mute microphone during response
                </mat-slide-toggle>
            }
        </div>

        <div class="sound-devices">
            <mat-form-field>
                <mat-label>Input Device</mat-label>
                <mat-select [(ngModel)]="config.input_device_name"
                            (ngModelChange)="onConfigChange({input_device_name: $event})">
                    @for (device of system?.input_device_names; track device) {
                        <mat-option [value]="device">{{ device }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>
            <mat-form-field>
                <mat-label>Output Device</mat-label>
                <mat-select [(ngModel)]="config.output_device_name"
                            (ngModelChange)="onConfigChange({output_device_name: $event})">
                    @for (device of system?.output_device_names; track device) {
                        <mat-option [value]="device">{{ device }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>
        </div>
        <div class="overlay-settings">
            <h2>Overlay</h2>
            <div class="overlay-controls">
                <mat-slide-toggle
                    [(ngModel)]="config.overlay_show_avatar"
                    (ngModelChange)="onConfigChange({overlay_show_avatar: $event})">
                    Show Avatar
                </mat-slide-toggle>

                <mat-slide-toggle
                    [(ngModel)]="config.overlay_show_chat"
                    (ngModelChange)="onConfigChange({overlay_show_chat: $event})">
                    Show Chat
                </mat-slide-toggle>

                <mat-form-field>
                    <mat-label>Position</mat-label>
                    <mat-select [(ngModel)]="config.overlay_position"
                                (ngModelChange)="onConfigChange({overlay_position: $event})">
                        <mat-option value="left">Left</mat-option>
                        <mat-option value="right">Right</mat-option>
                    </mat-select>
                </mat-form-field>
                
                <mat-form-field>
                    <mat-label>Screen Selection</mat-label>
                    <mat-select [(ngModel)]="config.overlay_screen_id"
                                (ngModelChange)="onConfigChange({overlay_screen_id: $event})">
                        <mat-option [value]="-1">Primary Screen</mat-option>
                        @for (screen of screens; track screen.id) {
                            <mat-option [value]="screen.id">{{ screen.label }}</mat-option>
                        }
                    </mat-select>
                </mat-form-field>
            </div>
        </div>
    }
</div>