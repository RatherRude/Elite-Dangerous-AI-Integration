<div class="quests-settings">
    <div class="quests-toolbar">
        <div class="toolbar-title">
            <h2>Quest Catalog</h2>
            @if (catalog) {
                <mat-form-field appearance="outline" class="version-field">
                    <mat-label>Version</mat-label>
                    <input matInput [(ngModel)]="catalog.version">
                </mat-form-field>
            }
        </div>
        <div class="toolbar-actions">
            <button mat-stroked-button color="primary" (click)="reloadCatalog()">
                Reload
            </button>
            <button mat-raised-button color="primary" (click)="saveCatalog()">
                Save
            </button>
        </div>
    </div>

    <div class="quests-layout">
        <mat-card class="quest-list">
            <mat-card-header>
                <mat-card-title>
                    Quests
                    <button mat-icon-button color="primary" (click)="addQuest()">
                        <mat-icon>add</mat-icon>
                    </button>
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                @if (catalog?.quests?.length) {
                    @for (quest of catalog?.quests; track quest.id; let questIndex = $index) {
                        <div class="quest-entry"
                             [class.selected]="quest.id === selectedQuestId">
                            <button mat-button (click)="selectQuest(quest.id)">
                                <span class="quest-title">{{ quest.title || quest.id }}</span>
                            </button>
                            <button mat-icon-button color="warn"
                                    (click)="removeQuest(questIndex)"
                                    aria-label="Remove quest">
                                <mat-icon>remove</mat-icon>
                            </button>
                        </div>
                    }
                } @else {
                    <p class="empty-state">No quests yet. Add one to begin.</p>
                }
            </mat-card-content>
        </mat-card>

        <div class="quest-editor">
            @if (loadError) {
                <mat-card class="quest-error" appearance="outlined">
                    <mat-card-content>
                        <p>{{ loadError }}</p>
                        @if (catalogPath) {
                            <p class="path">Path: {{ catalogPath }}</p>
                        }
                    </mat-card-content>
                </mat-card>
            } @else if (catalogPath || loadPending || lastLoadedAt) {
                <div class="quest-path">
                    @if (loadPending) {
                        Loading quest catalog...
                    } @else {
                        Loaded from {{ catalogPath || "unknown path" }}
                        @if (lastLoadedAt) {
                            ({{ lastLoadedAt }})
                        }
                    }
                </div>
            } @else {
                <div class="quest-path">
                    Awaiting quest catalog response. Click Reload to request it.
                </div>
            }

            @if (selectedQuest) {
                <mat-card class="quest-meta">
                    <mat-card-title>Quest Details</mat-card-title>
                    <mat-card-content>
                        <div class="quest-fields">
                            <mat-form-field>
                                <mat-label>Quest Id</mat-label>
                                <input matInput [(ngModel)]="selectedQuest.id">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Title</mat-label>
                                <input matInput [(ngModel)]="selectedQuest.title">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Description</mat-label>
                                <textarea matInput rows="3"
                                          [(ngModel)]="selectedQuest.description"></textarea>
                            </mat-form-field>
                            <mat-slide-toggle
                                [(ngModel)]="selectedQuest.active">
                                Active on start
                            </mat-slide-toggle>
                        </div>
                    </mat-card-content>
                </mat-card>

                <div class="stage-toolbar">
                    <h3>
                        Stages
                        <button mat-icon-button color="primary"
                                (click)="addStage(selectedQuest)">
                            <mat-icon>add</mat-icon>
                        </button>
                    </h3>
                </div>

                <div class="stage-graph" #stageGraph>
                    <svg class="stage-links"
                         [attr.width]="stageGraphSize.width"
                         [attr.height]="stageGraphSize.height">
                        @for (line of connectionLines; track lineIndex; let lineIndex = $index) {
                            <line
                                [attr.x1]="line.x1"
                                [attr.y1]="line.y1"
                                [attr.x2]="line.x2"
                                [attr.y2]="line.y2"></line>
                        }
                    </svg>
                    @for (column of getStageColumns(selectedQuest); track $index) {
                        <div class="stage-column">
                            @for (stage of column; track stage.id) {
                                <mat-card class="stage-card"
                                          #stageCard
                                          [attr.data-stage-id]="stage.id">
                                    <mat-card-header>
                                        <mat-card-title>
                                            <button mat-button class="stage-title-button"
                                                    (click)="toggleStageCollapsed(selectedQuest.id, stage.id)"
                                                    [attr.aria-expanded]="!isStageCollapsed(selectedQuest.id, stage.id)">
                                                <span>{{ stage.description || stage.id }}</span>
                                                <mat-icon>
                                                    {{ isStageCollapsed(selectedQuest.id, stage.id) ? 'expand_more' : 'expand_less' }}
                                                </mat-icon>
                                            </button>
                                            <button mat-icon-button color="warn"
                                                    (click)="removeStage(selectedQuest, selectedQuest.stages.indexOf(stage))">
                                                <mat-icon>remove</mat-icon>
                                            </button>
                                        </mat-card-title>
                                    </mat-card-header>
                                    @if (!isStageCollapsed(selectedQuest.id, stage.id)) {
                                        <mat-card-content>
                                        <div class="stage-meta">
                                            <mat-form-field>
                                                <mat-label>Stage Id</mat-label>
                                                <input matInput [(ngModel)]="stage.id">
                                            </mat-form-field>
                                            <mat-form-field>
                                                <mat-label>Description</mat-label>
                                                <input matInput [(ngModel)]="stage.description">
                                            </mat-form-field>
                                            <mat-form-field>
                                                <mat-label>Instructions</mat-label>
                                                <textarea matInput rows="2"
                                                          [(ngModel)]="stage.instructions"></textarea>
                                            </mat-form-field>
                                        </div>

                                        <div class="plan-steps">
                                            <div class="plan-header">
                                                <h4>
                                                    Choices
                                                    <button mat-icon-button color="primary"
                                                            (click)="addPlanStep(stage)">
                                                        <mat-icon>add</mat-icon>
                                                    </button>
                                                </h4>
                                            </div>
                                            @for (step of stage.plan ?? []; track stepIndex; let stepIndex = $index) {
                                                <mat-card class="plan-step">
                                                    <div class="plan-step-header">
                                                        <span>
                                                            Choice {{ stepIndex + 1 }}
                                                            <button mat-icon-button color="warn"
                                                                    (click)="removePlanStep(stage, stepIndex)">
                                                                <mat-icon>remove</mat-icon>
                                                            </button>
                                                        </span>
                                                    </div>

                                                    <div class="plan-section">
                                                        <div class="plan-section-header">
                                                            <h5>
                                                                Conditions
                                                                <button mat-icon-button color="primary"
                                                                        (click)="addCondition(step)">
                                                                    <mat-icon>add</mat-icon>
                                                                </button>
                                                            </h5>
                                                        </div>
                                                        @for (condition of step.conditions; track conditionIndex; let conditionIndex = $index) {
                                                            <div class="condition-row condensed">
                                                                <mat-form-field>
                                                                    <mat-label>Source</mat-label>
                                                                    <mat-select [(ngModel)]="condition.source">
                                                                        <mat-option value="event">event</mat-option>
                                                                        <mat-option value="projection">projection</mat-option>
                                                                    </mat-select>
                                                                </mat-form-field>
                                                                <mat-form-field>
                                                                    <mat-label>Property</mat-label>
                                                                    <input matInput [(ngModel)]="condition.path">
                                                                </mat-form-field>
                                                                @if (getConditionValueKind(condition) === 'boolean') {
                                                                    <mat-form-field>
                                                                        <mat-label>Value</mat-label>
                                                                        <mat-select [(ngModel)]="condition.value">
                                                                            <mat-option [value]="true">true</mat-option>
                                                                            <mat-option [value]="false">false</mat-option>
                                                                        </mat-select>
                                                                    </mat-form-field>
                                                                } @else {
                                                                    <mat-form-field>
                                                                        <mat-label>Value</mat-label>
                                                                        <input matInput
                                                                               [disabled]="getConditionValueKind(condition) === 'null'"
                                                                               [type]="getConditionValueKind(condition) === 'number' ? 'number' : 'text'"
                                                                               [value]="condition.value ?? ''"
                                                                               (input)="updateConditionValue(condition, $any($event.target).value)">
                                                                    </mat-form-field>
                                                                }
                                                                <button mat-icon-button color="warn"
                                                                        (click)="removeCondition(step, conditionIndex)">
                                                                    <mat-icon>remove</mat-icon>
                                                                </button>
                                                            </div>
                                                        }
                                                    </div>

                                                    <div class="plan-section">
                                                        <div class="plan-section-header">
                                                            <h5>
                                                                Actions
                                                                <button mat-icon-button color="primary"
                                                                        (click)="addAction(step)">
                                                                    <mat-icon>add</mat-icon>
                                                                </button>
                                                            </h5>
                                                        </div>
                                                        @for (action of step.actions; track actionIndex; let actionIndex = $index) {
                                                            <div class="action-row">
                                                                <mat-form-field>
                                                                    <mat-label>Action</mat-label>
                                                                    <mat-select [(ngModel)]="action.action">
                                                                        <mat-option value="log">log</mat-option>
                                                                        <mat-option value="advance_stage">advance_stage</mat-option>
                                                                        <mat-option value="set_active">set_active</mat-option>
                                                                    </mat-select>
                                                                </mat-form-field>

                                                                @if (action.action === 'log') {
                                                                    <mat-form-field>
                                                                        <mat-label>Message</mat-label>
                                                                        <input matInput [(ngModel)]="action.message">
                                                                    </mat-form-field>
                                                                }
                                                                @if (action.action === 'advance_stage') {
                                                                    <mat-form-field>
                                                                        <mat-label>Target Stage</mat-label>
                                                                    <mat-select [(ngModel)]="action.target_stage_id">
                                                                            @for (stageOption of selectedQuest.stages; track stageOption.id) {
                                                                                <mat-option [value]="stageOption.id">
                                                                                {{ stageOption.description || stageOption.id }}
                                                                                </mat-option>
                                                                            }
                                                                        </mat-select>
                                                                    </mat-form-field>
                                                                }
                                                                @if (action.action === 'set_active') {
                                                                    <mat-form-field>
                                                                        <mat-label>Quest Id</mat-label>
                                                                        <mat-select [(ngModel)]="action.quest_id">
                                                                            @for (questOption of catalog?.quests ?? []; track questOption.id) {
                                                                                <mat-option [value]="questOption.id">
                                                                                    {{ questOption.title || questOption.id }}
                                                                                </mat-option>
                                                                            }
                                                                        </mat-select>
                                                                    </mat-form-field>
                                                                    <mat-slide-toggle
                                                                        [(ngModel)]="action.active">
                                                                        Active
                                                                    </mat-slide-toggle>
                                                                }

                                                                <button mat-icon-button color="warn"
                                                                        (click)="removeAction(step, actionIndex)">
                                                                    <mat-icon>remove</mat-icon>
                                                                </button>

                                                                @if (action.action === 'advance_stage') {
                                                                    <div class="link-preview">
                                                                        @if (getStageById(selectedQuest, action.target_stage_id)) {
                                                                        } @else if (action.target_stage_id) {
                                                                            <span class="link-missing">Missing stage</span>
                                                                        }
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                </mat-card>
                                            }
                                        </div>
                                        </mat-card-content>
                                    }
                                </mat-card>
                            }
                        </div>
                    }
                </div>
            } @else {
                <mat-card class="empty-editor">
                    <mat-card-content>
                        <p>Select a quest to edit its stages.</p>
                        @if (catalog && !catalog.quests.length) {
                            <p class="empty-state">No quests found in the catalog.</p>
                        }
                    </mat-card-content>
                </mat-card>
            }

            <mat-expansion-panel class="yaml-panel">
                <mat-expansion-panel-header>
                    <mat-panel-title>Raw quests.yaml</mat-panel-title>
                </mat-expansion-panel-header>
                <mat-form-field class="yaml-field">
                    <textarea matInput rows="12" [value]="rawYaml" readonly></textarea>
                </mat-form-field>
                @if (!rawYaml) {
                    <div class="empty-state">No raw data received yet.</div>
                }
            </mat-expansion-panel>
        </div>
    </div>
</div>
