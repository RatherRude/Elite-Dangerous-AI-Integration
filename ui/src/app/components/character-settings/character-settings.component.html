<div class="settings-grid">
    @if (config && activeCharacter) {
        <h2>Personality</h2>
        <div [class.editing-active]="editMode">
            <!-- Character Management Section -->
            <div class="character-management-section">
                <div class="character-selector">
                    <mat-form-field appearance="fill">
                        <mat-label>Select Character</mat-label>
                        <mat-select [(value)]="selectedCharacterIndex" (selectionChange)="onCharacterSelect($event.value)" [disabled]="editMode">
                            <mat-divider *ngIf="config.characters && config.characters.length > 0"></mat-divider>
                            <mat-option *ngFor="let character of config.characters; let i = index" [value]="i">
                                {{ character.name }} ({{ character.tts_voice }})
                                <span class="char-details">
                                    {{ character.personality_preset | slice:0:1 | uppercase }}{{ character.personality_preset | slice:1 }} -
                                    {{ countActiveEvents(character) }} active events
                                </span>
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    @if (!editMode) {
                        <div class="character-display" [class.with-traits]="!isCustomPreset()">
                            <div class="character-avatar-preview">
                                <img [src]="getAvatarUrl()" 
                                     [alt]="activeCharacter.name + ' avatar'"
                                     class="avatar-preview-image">
                            </div>
                            <div class="character-content">
                                <span class="trait-label">{{activeCharacter.name}}:</span>
                                {{activeCharacter.character}}
                            </div>
                            @if (!isCustomPreset()) {
                                <div class="character-traits">
                                    <div class="trait-item">
                                        <span class="trait-label">Inspiration:</span>
                                        <span class="trait-value">{{activeCharacter.personality_character_inspiration}}</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Verbosity:</span>
                                        <span class="trait-value">{{activeCharacter.personality_verbosity}}%</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Vulgarity:</span>
                                        <span class="trait-value">{{activeCharacter.personality_vulgarity}}%</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Empathy:</span>
                                        <span class="trait-value">{{activeCharacter.personality_empathy}}%</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Formality:</span>
                                        <span class="trait-value">{{activeCharacter.personality_formality}}%</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Confidence:</span>
                                        <span class="trait-value">{{activeCharacter.personality_confidence}}%</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Tone:</span>
                                        <span class="trait-value">{{activeCharacter.personality_tone}}</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Ethical Alignment:</span>
                                        <span class="trait-value">{{activeCharacter.personality_ethical_alignment}}</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Moral Alignment:</span>
                                        <span class="trait-value">{{activeCharacter.personality_moral_alignment}}</span>
                                    </div>
                                    <div class="trait-item">
                                        <span class="trait-label">Knowledge:</span>
                                        <div class="trait-value">
                                            <span [class.active]="activeCharacter.personality_knowledge_pop_culture">pop culture</span>
                                            <span [class.active]="activeCharacter.personality_knowledge_scifi">sci-fi</span>
                                            <span [class.active]="activeCharacter.personality_knowledge_history">history</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <div class="character-buttons">
                        <!-- When not in edit mode, show Edit and New buttons -->
                        @if (!editMode) {
                            <button mat-raised-button color="primary"
                                    [disabled]="selectedCharacterIndex === 0"
                                    [matTooltip]="'Edit the selected character and event reactions.'"
                                    (click)="toggleEditMode()">
                                <mat-icon>edit</mat-icon> Edit
                            </button>

                            <button mat-raised-button color="accent" (click)="addNewCharacter()"
                                    [matTooltip]="selectedCharacterIndex === 0 ? 'Create a new character to allow editing of character traits and prompt' : 'Create new character.'">
                                <mat-icon>add</mat-icon> New

                            </button>

                            <button mat-raised-button color="accent" 
                                    (click)="duplicateSelectedCharacter()"
                                    [matTooltip]="selectedCharacterIndex === 0 ? 'Duplicate this character. You can edit character traits after duplicating.': 'Duplicate this character.'">
                                <mat-icon>content_copy</mat-icon> Duplicate
                            </button>

                            <button mat-raised-button color="warn"
                                    [disabled]="selectedCharacterIndex === 0"
                                    (click)="deleteSelectedCharacter()"
                                    [matTooltip]="'Delete current character.'">
                                <mat-icon>delete</mat-icon> Delete
                            </button>
                        }

                        <!-- When in edit mode, show Save and Cancel buttons -->
                        @if (editMode) {
                            <button mat-raised-button color="primary" (click)="saveCharacters()"
                                    [matTooltip]="'Save character.'" >
                                <mat-icon>save</mat-icon> Save
                            </button>

                            <button mat-raised-button (click)="cancelEditMode()"
                                    [matTooltip]="'Cancel current edit.'" >

                                <mat-icon>cancel</mat-icon> Cancel
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Character settings - only visible when editing -->
            <div id="character-creation" *ngIf="editMode">
                <!-- Avatar Section -->
                <div class="avatar-edit-section">
                    <div class="avatar-container">
                        <!-- Avatar Image (Left Side) -->
                        <div class="avatar-display-container">
                            <div class="avatar-full-display">
                                <img [src]="getAvatarUrl()" 
                                     [alt]="activeCharacter.name + ' avatar'"
                                     class="avatar-full-image">
                                <button mat-icon-button 
                                        class="avatar-edit-button"
                                        (click)="openAvatarCatalog()"
                                        matTooltip="Change avatar">
                                    <mat-icon>edit</mat-icon>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Avatar Options (Right Side) -->
                        <div class="avatar-options-container">
                            <!-- Show Avatar -->
                            <div class="avatar-option">
                                <mat-slide-toggle 
                                    [ngModel]="getCharacterProperty('avatar_show', true)"
                                    [disabled]="config?.edcopilot === true && config?.edcopilot_dominant === true"
                                    (ngModelChange)="setCharacterProperty('avatar_show', $event)"
                                    [matTooltip]="config?.edcopilot === true && config?.edcopilot_dominant === true ? 'Avatars are disabled while using EDCP-dominant mode' : 'Toggle avatar visibility'">
                                    Show Avatar
                                </mat-slide-toggle>
                            </div>
                            
                            <!-- Position (hidden if not showing avatar) -->
                            <div class="avatar-option" *ngIf="getCharacterProperty('avatar_show', true)">
                                <mat-form-field appearance="outline">
                                    <mat-label>Position</mat-label>
                                    <mat-select 
                                        [ngModel]="getCharacterProperty('avatar_position', 'right')"
                                        (ngModelChange)="setCharacterProperty('avatar_position', $event)">
                                        <mat-option value="left">Left</mat-option>
                                        <mat-option value="right">Right</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            
                            <!-- Flip (hidden if not showing avatar) -->
                            <div class="avatar-option" *ngIf="getCharacterProperty('avatar_show', true)">
                                <mat-slide-toggle 
                                    [ngModel]="getCharacterProperty('avatar_flip', false)"
                                    (ngModelChange)="setCharacterProperty('avatar_flip', $event)"
                                    matTooltip="Flip avatar horizontally">
                                    Flip
                                </mat-slide-toggle>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Character Name -->
                <div class="character-settings">
                    <div class="trait-container">
                        <div class="trait-input">
                            <mat-form-field appearance="outline">
                                <mat-label>Character Name</mat-label>
                                <input matInput
                                    [ngModel]="activeCharacter.name"
                                    [ngModelOptions]="{updateOn: 'blur'}"
                                    (ngModelChange)="setCharacterPropertyAndUpdatePrompt('name', $event)">
                            </mat-form-field>
                        </div>
                        <div class="trait-input">
                            <!-- Character Language -->
                            <mat-form-field appearance="outline">
                                <mat-label>Character Language</mat-label>
                                <input matInput
                                    [ngModel]="activeCharacter.personality_language"
                                    [ngModelOptions]="{updateOn: 'blur'}"
                                    (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_language', $event)">
                            </mat-form-field>
                        </div>
                        <div class="trait-select">
                            <!-- Voice selection -->
                            <mat-form-field>
                                <mat-label>Voice</mat-label>
                                @if (config.tts_provider === 'openai') {
                                    <mat-select [ngModel]="activeCharacter.tts_voice"
                                            (ngModelChange)="setCharacterProperty('tts_voice', $event)">
                                        <mat-option value="alloy">Alloy - Neutral, versatile voice</mat-option>
                                        <mat-option value="ash">Ash - New voice</mat-option>
                                        <mat-option value="ballad">Ballad - New voice</mat-option>
                                        <mat-option value="coral">Coral - New voice</mat-option>
                                        <mat-option value="echo">Echo - Deeper, experienced voice</mat-option>
                                        <mat-option value="fable">Fable - Warm, soft-spoken voice</mat-option>
                                        <mat-option value="nova">Nova - Bright, friendly voice</mat-option>
                                        <mat-option value="onyx">Onyx - Deep, authoritative voice</mat-option>
                                        <mat-option value="sage">Sage - New voice</mat-option>
                                        <mat-option value="shimmer">Shimmer - Clear, warm voice</mat-option>
                                    </mat-select>
                                } @else if (config.tts_provider === 'edge-tts') {
                                    <mat-select [ngModel]="activeCharacter.tts_voice"
                                            (selectionChange)="onVoiceSelectionChange($event.value)">
                                        @if (isCustomVoice(activeCharacter.tts_voice)) {
                                            <mat-option [value]="activeCharacter.tts_voice" style="font-style: italic">
                                                {{ getVoiceDisplayName(activeCharacter.tts_voice) }}
                                            </mat-option>
                                            <mat-divider class="custom-voice-divider"></mat-divider>
                                        }
                                        <mat-optgroup label="English - United States">
                                            <mat-option value="en-US-AvaMultilingualNeural">Ava Multilingual (Female)</mat-option>
                                            <mat-option value="en-US-AndrewMultilingualNeural">Andrew Multilingual (Male)</mat-option>
                                            <mat-option value="en-US-AriaNeural">Aria (Female) - Positive, Confident</mat-option>
                                            <mat-option value="en-US-AnaNeural">Ana (Female) - Cute</mat-option>
                                            <mat-option value="en-US-ChristopherNeural">Christopher (Male) - Reliable, Authority</mat-option>
                                            <mat-option value="en-US-EricNeural">Eric (Male) - Rational</mat-option>
                                            <mat-option value="en-US-GuyNeural">Guy (Male) - Passion</mat-option>
                                            <mat-option value="en-US-JennyNeural">Jenny (Female) - Friendly, Considerate</mat-option>
                                            <mat-option value="en-US-MichelleNeural">Michelle (Female) - Friendly, Pleasant</mat-option>
                                            <mat-option value="en-US-RogerNeural">Roger (Male) - Lively</mat-option>
                                            <mat-option value="en-US-SteffanNeural">Steffan (Male) - Rational</mat-option>
                                        </mat-optgroup>
                                        <mat-optgroup label="English - United Kingdom">
                                            <mat-option value="en-GB-LibbyNeural">Libby (Female)</mat-option>
                                            <mat-option value="en-GB-MaisieNeural">Maisie (Female)</mat-option>
                                            <mat-option value="en-GB-RyanNeural">Ryan (Male)</mat-option>
                                            <mat-option value="en-GB-SoniaNeural">Sonia (Female)</mat-option>
                                            <mat-option value="en-GB-ThomasNeural">Thomas (Male)</mat-option>
                                        </mat-optgroup>
                                        <mat-optgroup label="English - Australia">
                                            <mat-option value="en-AU-NatashaNeural">Natasha (Female)</mat-option>
                                            <mat-option value="en-AU-WilliamNeural">William (Male)</mat-option>
                                        </mat-optgroup>
                                        <mat-option value="show-all-voices">Show All Voices...</mat-option>
                                    </mat-select>
                                } @else {
                                    <input matInput [ngModel]="activeCharacter.tts_voice"
                                        (ngModelChange)="setCharacterProperty('tts_voice', $event)">
                                }
                            </mat-form-field>
                        </div>
                        <div class="trait-select">
                            <!-- Voice speed -->
                            @if (!voiceInstructionSupportedModels.includes(config.tts_model_name)) {
                                <div class="trait-select lowWidth">
                                    <mat-form-field>
                                        <mat-label>Speed</mat-label>
                                        <input matInput [ngModel]="activeCharacter.tts_speed"
                                                (ngModelChange)="setCharacterProperty('tts_speed', $event)">
                                    </mat-form-field>
                                </div>
                            }

                            <!-- TTS Prompt -->
                            @if (voiceInstructionSupportedModels.includes(config.tts_model_name)) {
                                <div class="trait-select">
                                    <mat-hint><b>Voice instructions</b><br>Enter a detailed description of how you want your voice to sound.<br>You can include things such as: accent, emotional range, tone, impressions and speed.<br>
                                        Warning: This will increase the cost of each query!</mat-hint>
                                    <mat-form-field>
                                        <mat-label>Voice Tone Instructions</mat-label>
                                        <textarea matInput [ngModel]="activeCharacter.tts_prompt"
                                                (ngModelChange)="setCharacterProperty('tts_prompt', $event)"></textarea>

                                    </mat-form-field>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Personality Preset -->
                <div class="trait-container">
                    <div class="trait-select">
                        <mat-form-field appearance="fill">
                            <mat-label>Personality Preset</mat-label>
                            <mat-select [value]="activeCharacter.personality_preset" 
                                        (selectionChange)="applySettingsFromPreset($event.value)"  
                                        [matTooltip]="'Select a predefined personality role or write your own.'"
                                        tooltipPosition="right">
                                <mat-option value="default">Default</mat-option>
                                <mat-option value="custom">Write your own prompt</mat-option>
                                <mat-option disabled>--- Elite: Dangerous Roles ---</mat-option>
                                <mat-option value="explorer">Explorer</mat-option>
                                <mat-option value="trader">Trader</mat-option>
                                <mat-option value="miner">Miner</mat-option>
                                <mat-option value="bountyHunter">Bounty Hunter</mat-option>
                                <mat-option value="pirate">Pirate</mat-option>
                                <mat-option value="smuggler">Smuggler</mat-option>
                                <mat-option value="mercenary">Mercenary</mat-option>
                                <mat-option value="missionRunner">Mission Runner</mat-option>
                                <mat-option value="passengerTransporter">Passenger Transporter</mat-option>
                                <mat-option value="powerplayAgent">Powerplay Agent</mat-option>
                                <mat-option value="axCombatPilot">AX Combat Pilot</mat-option>
                                <mat-option value="pvpCombatant">PvP Combatant</mat-option>
                                <mat-option value="pveCombatant">PvE Combatant</mat-option>
                                <mat-option value="salvager">Salvager</mat-option>
                                <mat-option value="cannonResearcher">Cannon Researcher</mat-option>
                                <mat-option value="fuelRat">Fuel Rat/Support</mat-option>
                                <mat-option value="fleetCarrierOperator">Fleet Carrier Operator</mat-option>
                                <mat-option value="bgsPlayer">BGS Player</mat-option>
                                <mat-option value="racer">Race Pilot</mat-option>
                                <mat-option disabled>--- Roleplaying Characters ---</mat-option>
                                <mat-option value="diplomat">Diplomat</mat-option>
                                <mat-option value="spy">Spy / Infiltrator</mat-option>
                                <mat-option value="cultLeader">Cult Leader</mat-option>
                                <mat-option value="rogueAI">Rogue AI / Synthetic Being</mat-option>
                                <mat-option value="xenologist">Xenologist</mat-option>
                                <mat-option value="vigilante">Renegade Cop / Vigilante</mat-option>
                                <mat-option value="warCorrespondent">War Correspondent</mat-option>
                                <mat-option value="propagandist">Propagandist</mat-option>
                                <mat-option value="pirateLord">Pirate Lord / Crime Boss</mat-option>
                                <mat-option value="veteran">Disillusioned Veteran</mat-option>
                                <mat-option value="freedomFighter">Freedom Fighter</mat-option>
                                <mat-option value="hermit">Hermit / Space Nomad</mat-option>
                                <mat-option value="corporate">Corporate Operative</mat-option>
                                <mat-option value="zealot">Religious Zealot</mat-option>
                                <mat-option value="historian">Historian / Archivist</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                
                <!-- Character settings when preset is not custom -->
                @if (activeCharacter.personality_preset !== 'custom') {
                    <div class="personality-settings">
                        <div class="trait-container">
                            <!-- Character Inspiration -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Character Inspiration</mat-label>
                                    <input matInput
                                        [ngModel]="activeCharacter.personality_character_inspiration"
                                        [ngModelOptions]="{updateOn: 'blur'}"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_character_inspiration', $event)">
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="trait-container">
                            <!-- Verbosity Setting -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Verbosity</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_verbosity"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_verbosity', $event)">
                                        <mat-option [value]="0">Minimal</mat-option>
                                        <mat-option [value]="25">Brief</mat-option>
                                        <mat-option [value]="50">Balanced</mat-option>
                                        <mat-option [value]="75">Detailed</mat-option>
                                        <mat-option [value]="100">Verbose</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Tone Setting -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Tone</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_tone"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_tone', $event)">
                                        <mat-option value="serious">Serious</mat-option>
                                        <mat-option value="humorous">Humorous</mat-option>
                                        <mat-option value="sarcastic">Sarcastic</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Vulgarity Setting -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Vulgarity</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_vulgarity"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_vulgarity', $event)">
                                        <mat-option [value]="0">None</mat-option>
                                        <mat-option [value]="25">Mild</mat-option>
                                        <mat-option [value]="50">Moderate</mat-option>
                                        <mat-option [value]="75">Strong</mat-option>
                                        <mat-option [value]="100">Extreme</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="trait-container">
                            <!-- Empathy Level -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Empathy</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_empathy"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_empathy', $event)">
                                        <mat-option [value]="0">Cold</mat-option>
                                        <mat-option [value]="25">Detached</mat-option>
                                        <mat-option [value]="50">Balanced</mat-option>
                                        <mat-option [value]="75">Caring</mat-option>
                                        <mat-option [value]="100">Highly Empathetic</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Formality Level -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Formality</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_formality"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_formality', $event)">
                                        <mat-option [value]="0">Casual</mat-option>
                                        <mat-option [value]="25">Relaxed</mat-option>
                                        <mat-option [value]="50">Balanced</mat-option>
                                        <mat-option [value]="75">Professional</mat-option>
                                        <mat-option [value]="100">Formal</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Confidence Level -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Confidence</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_confidence"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_confidence', $event)">
                                        <mat-option [value]="0">Uncertain</mat-option>
                                        <mat-option [value]="25">Tentative</mat-option>
                                        <mat-option [value]="50">Balanced</mat-option>
                                        <mat-option [value]="75">Confident</mat-option>
                                        <mat-option [value]="100">Authoritative</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="trait-container">
                            <!-- Ethical Axis (Law vs. Chaos) -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Ethical Alignment</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_ethical_alignment"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_ethical_alignment', $event)">
                                        <mat-option value="lawful">Lawful (Order, Rules, Structure)</mat-option>
                                        <mat-option value="neutral">Neutral (Balance, Pragmatism)</mat-option>
                                        <mat-option value="chaotic">Chaotic (Freedom, Flexibility, Spontaneity)</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Moral Axis (Good vs. Evil) -->
                            <div class="trait-select">
                                <mat-form-field appearance="outline">
                                    <mat-label>Moral Alignment</mat-label>
                                    <mat-select [ngModel]="activeCharacter.personality_moral_alignment"
                                        (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_moral_alignment', $event)">
                                        <mat-option value="good">Good (Altruism, Compassion)</mat-option>
                                        <mat-option value="neutral">Neutral (Self-Interest, Balance)</mat-option>
                                        <mat-option value="evil">Evil (Selfishness, Ruthlessness)</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Knowledge Areas -->
                        <div class="knowledge-areas">
                            <label class="knowledge-label">Knowledge Areas</label>
                            <div class="knowledge-checkboxes">
                                <mat-checkbox [ngModel]="activeCharacter.personality_knowledge_pop_culture"
                                            (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_knowledge_pop_culture', $event)">Pop Culture</mat-checkbox>
                                <mat-checkbox [ngModel]="activeCharacter.personality_knowledge_scifi"
                                            (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_knowledge_scifi', $event)">Sci-Fi</mat-checkbox>
                                <mat-checkbox [ngModel]="activeCharacter.personality_knowledge_history"
                                            (ngModelChange)="setCharacterPropertyAndUpdatePrompt('personality_knowledge_history', $event)">History</mat-checkbox>
                            </div>
                        </div>
                    </div>
                    
                    <div class="character-display">
                        <h4>Character Prompt</h4>
                        <div class="character-content">{{activeCharacter.character}}</div>
                    </div>
                } @else {
                    <div class="trait-container">
                        <mat-form-field>
                            <mat-label>Character</mat-label>
                            <textarea matInput [ngModel]="activeCharacter.character"
                                    [ngModelOptions]="{updateOn: 'blur'}"
                                    (ngModelChange)="setCharacterProperty('character', $event)"
                                    rows="10"></textarea>
                        </mat-form-field>
                    </div>
                }
            </div>
        </div>

        @if (editMode) {
            <h2>Reactions</h2>

            <mat-slide-toggle [ngModel]="getCharacterProperty('event_reaction_enabled_var', false)"
                                (ngModelChange)="setCharacterProperty('event_reaction_enabled_var', $event)">
                Enable Event Reactions
            </mat-slide-toggle>
            <p>Events are caused by the game and your actions within it. By default, the AI will react to those
                events and provide additional details or commentary. You can customize the reactions in the <a
                        href="#" (click)="eventReactionsSection.scrollIntoView()">Customize Event Reactions</a>
                section below.</p>

            <h3 #eventReactionsSection>Customize Event Reactions</h3>
            <p>This section allows you to customize the event reactions for the game and will allow you to make
                the AI react less or more often.</p>

            @if (getCharacterProperty('event_reaction_enabled_var', false)) {
                <div class="event-search-and-reset">
                    <mat-form-field class="search-box" subscriptSizing="dynamic">
                        <mat-label>Search events</mat-label>
                        <input matInput [(ngModel)]="eventSearchQuery"
                                (ngModelChange)="filterEvents($event)"
                                placeholder="Type to search events...">
                        <button *ngIf="eventSearchQuery" matSuffix mat-icon-button (click)="clearEventSearch()">
                            <mat-icon>close</mat-icon>
                        </button>
                    </mat-form-field>

                    <button mat-raised-button color="warn" (click)="resetGameEvents()"
                            [matTooltip]="'Reset the event reactions to the default set.'">
                        <mat-icon>restart_alt</mat-icon> Reset to Defaults

                    </button>
                </div>

                <mat-accordion multi="false">
                    @for (section of filteredGameEvents | keyvalue:orderByKey; track section.key) {
                        <mat-expansion-panel [expanded]="isSectionExpanded(section.key)"
                                                (afterExpand)="onSectionToggled(section.key)"
                                                (afterCollapse)="onSectionToggled(null)">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    {{ section.key }}
                                </mat-panel-title>
                            </mat-expansion-panel-header>
                            @for (e of section.value | keyvalue:orderByKey; track e.key) {
                                <mat-slide-toggle
                                        [(ngModel)]="activeCharacter.game_events[e.key]"
                                        (ngModelChange)="onEventConfigChange(section.key, e.key, $event)"
                                        [appTooltip]="GameEventTooltips[e.key]"
                                        tooltipPosition="right"
                                    >
                                        {{ e.key }}
                                </mat-slide-toggle>
                                @if (e.key === "ProspectedAsteroid") {
                                    <mat-form-field>
                                        <mat-label>React to material</mat-label>
                                        <mat-select multiple
                                                    [value]="getMaterialsArray(getCharacterProperty('react_to_material', ''))"
                                                    (selectionChange)="onMaterialsChange($event.value)">
                                            <mat-option value="Alexandrite">Alexandrite</mat-option>
                                            <mat-option value="Benitoite">Benitoite</mat-option>
                                            <mat-option value="Bromellite">Bromellite</mat-option>
                                            <mat-option value="Grandidierite">Grandidierite</mat-option>
                                            <mat-option value="LowTemperatureDiamond">LowTemperatureDiamond</mat-option>
                                            <mat-option value="Monazite">Monazite</mat-option>
                                            <mat-option value="Musgravite">Musgravite</mat-option>
                                            <mat-option value="Opal">Opal</mat-option>
                                            <mat-option value="Painite">Painite</mat-option>
                                            <mat-option value="Platinum">Platinum</mat-option>
                                            <mat-option value="Rhodplumsite">Rhodplumsite</mat-option>
                                            <mat-option value="Serendibite">Serendibite</mat-option>
                                            <mat-option value="Tritium">Tritium</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                }
                                @if (e.key === "InDanger") {
                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_danger_mining_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_danger_mining_var', $event)"
                                        [appTooltip]="'React to in danger whilst mining or not.'"
                                        tooltipPosition="right"
                                    >
                                        React while mining
                                    </mat-slide-toggle>
                                    </div>

                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_danger_onfoot_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_danger_onfoot_var', $event)"
                                        [appTooltip]="'React to in danger whilst on foot or not.'"
                                        tooltipPosition="right"
                                    >
                                        React while on-foot
                                    </mat-slide-toggle>
                                    </div>

                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_danger_supercruise_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_danger_supercruise_var', $event)"
                                        [appTooltip]="'React to in danger whilst in supercruise or not.'"
                                        tooltipPosition="right"
                                    >
                                        React while in supercruise
                                    </mat-slide-toggle>
                                    </div>
                                }

                                @if (e.key === "ReceiveText") {
                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_text_local_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_text_local_var', $event)"
                                        [appTooltip]="'React to local text or not'"
                                        tooltipPosition="right"
                                    >
                                    React to local text
                                    </mat-slide-toggle>
                                </div>

                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_text_starsystem_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_text_starsystem_var', $event)"
                                        [appTooltip]="'React to starsystem text or not'"
                                        tooltipPosition="right"
                                    >
                                        React to starsystem text
                                    </mat-slide-toggle>
                                    </div>

                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_text_squadron_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_text_squadron_var', $event)"
                                        [appTooltip]="'React to squadron text or not'"
                                        tooltipPosition="right"
                                    >
                                        React to squadron text
                                    </mat-slide-toggle>
                                    </div>

                                <div class="event-suboption">
                                    <mat-slide-toggle
                                        [ngModel]="getCharacterProperty('react_to_text_npc_var', false)"
                                        (ngModelChange)="setCharacterProperty('react_to_text_npc_var', $event)"
                                        [appTooltip]="'React to npc text or not'"
                                        tooltipPosition="right"
                                    >
                                        React to NPC text
                                    </mat-slide-toggle>
                                    </div>
                                }

                                @if (e.key === "Idle") {
                                    <mat-form-field>
                                        <mat-label>Idle Timeout (seconds)</mat-label>
                                        <input matInput type="number" 
                                                [ngModel]="getCharacterProperty('idle_timeout_var', 300)"
                                                (ngModelChange)="setCharacterProperty('idle_timeout_var', $event)"
                                                min="60">
                                        <mat-hint>Time in seconds before AI considers you idle (min 60)</mat-hint>
                                    </mat-form-field>
                                }
                                <br/>
                            }
                        </mat-expansion-panel>
                    }
                </mat-accordion>
            }
        }

        <h2>Conversation History</h2>
        <div class="clear_history">
            <p>This will clear the entire conversation history with the AI. If you change the character, you may want to reset the conversation history, so
            the AI starts with a blank slate.</p>
            <button mat-stroked-button color="warn" (click)="onClearHistory()">
                <mat-icon>delete_sweep</mat-icon>
                Clear History
            </button>
        </div>
    }
</div>